/*!
 * Connect - directory
 * Copyright(c) 2011 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */// TODO: icon / style for directories
// TODO: arrow key navigation
// TODO: make icons extensible
/**
 * Module dependencies.
 */function htmlPath(e){var t=[];return e.split("/").map(function(e){t.push(encodeURIComponent(e));return e?'<a href="'+t.join("/")+'">'+e+"</a>":""}).join(" / ")}function html(e,t,n){return'<ul id="files">'+e.map(function(e){var r="",i=[],s=t.split("/").map(function(e){return encodeURIComponent(e)});if(n&&".."!=e){r=icons[extname(e)]||icons.default;r='<img src="data:image/png;base64,'+load(r)+'" />';i.push("icon")}s.push(encodeURIComponent(e));return'<li><a href="'+utils.normalizeSlashes(normalize(s.join("/")))+'" class="'+i.join(" ")+'"'+' title="'+e+'">'+r+e+"</a></li>"}).join("\n")+"</ul>"}function load(e){return cache[e]?cache[e]:cache[e]=fs.readFileSync(__dirname+"/../public/icons/"+e,"base64")}function removeHidden(e){return e.filter(function(e){return"."!=e[0]})}var fs=require("fs"),parse=require("url").parse,utils=require("../utils"),path=require("path"),normalize=path.normalize,sep=path.sep,extname=path.extname,join=path.join,Negotiator=require("negotiator"),cache={},mediaTypes=["text/html","text/plain","application/json"],mediaType={"text/html":"html","text/plain":"plain","application/json":"json"};exports=module.exports=function(t,n){n=n||{};if(!t)throw new Error("directory() root path required");var r=n.hidden,i=n.icons,s=n.filter,t=normalize(t+sep);return function(n,o,u){if("GET"!=n.method&&"HEAD"!=n.method)return u();var a=parse(n.url),f=decodeURIComponent(a.pathname),l=normalize(join(t,f)),c=parse(n.originalUrl),h=decodeURIComponent(c.pathname),p=l!=t;if(~l.indexOf("\0"))return u(utils.error(400));if(0!=l.indexOf(t))return u(utils.error(403));fs.stat(l,function(e,t){if(e)return"ENOENT"==e.code?u():u(e);if(!t.isDirectory())return u();fs.readdir(l,function(e,t){if(e)return u(e);r||(t=removeHidden(t));s&&(t=t.filter(s));t.sort();var a=(new Negotiator(n)).preferredMediaType(mediaTypes);if(!a)return u(utils.error(406));exports[mediaType[a]](n,o,t,u,h,p,i)})})}};exports.html=function(e,t,n,r,i,s,o){fs.readFile(__dirname+"/../public/directory.html","utf8",function(e,u){if(e)return r(e);fs.readFile(__dirname+"/../public/style.css","utf8",function(e,a){if(e)return r(e);s&&n.unshift("..");u=u.replace("{style}",a).replace("{files}",html(n,i,o)).replace("{directory}",i).replace("{linked-path}",htmlPath(i));t.setHeader("Content-Type","text/html");t.setHeader("Content-Length",u.length);t.end(u)})})};exports.json=function(e,t,n){n=JSON.stringify(n);t.setHeader("Content-Type","application/json");t.setHeader("Content-Length",n.length);t.end(n)};exports.plain=function(e,t,n){n=n.join("\n")+"\n";t.setHeader("Content-Type","text/plain");t.setHeader("Content-Length",n.length);t.end(n)};var icons={".js":"page_white_code_red.png",".c":"page_white_c.png",".h":"page_white_h.png",".cc":"page_white_cplusplus.png",".php":"page_white_php.png",".rb":"page_white_ruby.png",".cpp":"page_white_cplusplus.png",".swf":"page_white_flash.png",".pdf":"page_white_acrobat.png","default":"page_white.png"};