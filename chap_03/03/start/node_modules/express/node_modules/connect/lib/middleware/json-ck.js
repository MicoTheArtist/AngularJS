/*!
 * Connect - json
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 *//**
 * Module dependencies.
 */var utils=require("../utils"),getBody=require("raw-body"),bytes=require("bytes");exports=module.exports=function(e){e=e||{};var t=e.strict!==!1,n=typeof e.verify=="function"&&e.verify,r=e.limit?typeof e.limit=="number"?e.limit:typeof e.limit=="string"?bytes(e.limit):null:bytes("1mb");return function(s,o,u){if(s._body)return u();s.body=s.body||{};if(!utils.hasBody(s))return u();if(!exports.regexp.test(utils.mime(s)))return u();s._body=!0;getBody(s,{limit:r,expected:s.headers["content-length"]},function(r,i){if(r)return u(r);if(n)try{n(s,o,i)}catch(r){r.status||(r.status=403);return u(r)}i=i.toString("utf8").trim();var a=i[0];if(0==i.length)return u(utils.error(400,"invalid json, empty body"));if(t&&"{"!=a&&"["!=a)return u(utils.error(400,"invalid json"));try{s.body=JSON.parse(i,e.reviver)}catch(r){r.body=i;r.status=400;return u(r)}u()})}};exports.regexp=/^application\/([\w!#\$%&\*`\-\.\^~]*\+)?json$/i;